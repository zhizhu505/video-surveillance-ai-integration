# 危险等级告警系统指南

## 概述

本系统已升级为支持危险等级分类的智能告警系统，能够根据不同的告警类型自动分配危险等级，并在Web界面中以不同颜色显示。

## 危险等级定义

### 1. 低危险等级 (Low) - 绿色
- **Large Area Motion (大面积运动)**: 检测到画面中大面积的运动
- **Sudden Motion (突然运动)**: 检测到突然的运动变化

### 2. 中危险等级 (Medium) - 黄色  
- **Intrusion Alert (入侵告警)**: 检测到人员进入禁止区域
- **Loitering (逗留检测)**: 检测到人员在特定区域长时间逗留
- **Danger Zone Dwell (危险区域停留)**: 检测到人员在危险区域停留

### 3. 高危险等级 (High) - 红色
- **Fall Detection (摔倒检测)**: 检测到可能的摔倒行为
- **Abnormal Pattern (异常模式)**: 检测到异常的行为模式

## 功能特性

### 1. 自动危险等级分类
- 系统根据告警类型自动分配危险等级
- 无需手动配置，基于预设规则自动判断

### 2. 可视化颜色区分
- **低危险**: 绿色边框和背景
- **中危险**: 黄色边框和背景  
- **高危险**: 红色边框和背景

### 3. 告警详情显示
- 点击告警可查看详细信息
- 包含危险等级、置信度、时间等信息
- 支持标记为已处理/未处理

### 4. 新告警从下方生成
- 新的告警信息从告警列表下方添加
- 避免干扰用户正在查看的告警

## 使用方法

### 1. 启动系统
```bash
# 使用批处理脚本启动
run_danger_level_test.bat

# 或直接使用Python命令
python src/all_in_one_system.py --web-interface --web-port 5000
```

### 2. 访问Web界面
- 打开浏览器访问: http://localhost:5000
- 查看实时视频流和告警信息

### 3. 查看告警
- 告警列表显示在右侧面板
- 不同颜色表示不同危险等级
- 点击告警查看详细信息

### 4. 处理告警
- 点击"标记处理"按钮将告警标记为已处理
- 点击"取消处理"按钮将告警标记为未处理
- 处理状态会影响统计信息

## 配置说明

### 告警规则配置
配置文件: `src/config/rules.json`

```json
{
  "rules": [
    {
      "id": "large_area_motion",
      "name": "Large Area Motion",
      "danger_level": "low",
      "severity": "低"
    },
    {
      "id": "fall_detection", 
      "name": "Fall Detection",
      "danger_level": "high",
      "severity": "高"
    }
  ]
}
```

### 危险等级映射
在 `src/danger_recognizer.py` 中定义:

```python
DANGER_LEVELS = {
    'sudden_motion': 'low',
    'large_area_motion': 'low', 
    'fall': 'high',
    'intrusion': 'medium',
    'loitering': 'medium',
    'danger_zone_dwell': 'medium',
}
```

## 测试验证

### 运行测试脚本
```bash
python test_danger_levels.py
```

测试脚本将验证:
- 危险等级映射是否正确
- 告警生成是否包含危险等级信息
- Web接口是否正确显示危险等级

### 测试场景
1. **大面积运动测试**: 在摄像头前进行大幅度运动
2. **突然运动测试**: 快速移动或突然停止
3. **摔倒检测测试**: 模拟摔倒动作
4. **入侵检测测试**: 进入设定的告警区域

## 技术实现

### 后端实现
- `DangerRecognizer`: 危险识别器，负责检测和分类告警
- `AlertEvent`: 告警事件类，包含危险等级字段
- `AlertProcessor`: 告警处理器，管理告警生命周期

### 前端实现
- HTML模板: `templates/index.html`
- CSS样式: 不同危险等级的颜色样式
- JavaScript: 告警渲染和交互逻辑

### 数据流
1. 视频帧 → 特征提取 → 危险检测
2. 检测结果 → 告警生成 → 危险等级分配
3. 告警数据 → Web接口 → 前端显示

## 故障排除

### 常见问题
1. **告警不显示危险等级**: 检查告警数据是否包含 `danger_level` 字段
2. **颜色显示不正确**: 检查CSS样式是否正确加载
3. **新告警不从下方生成**: 检查JavaScript逻辑是否正确

### 调试方法
1. 查看浏览器控制台错误信息
2. 检查后端日志输出
3. 使用测试脚本验证功能

## 更新日志

### v2.0.0 (当前版本)
- ✅ 新增危险等级分类系统
- ✅ 实现颜色区分显示
- ✅ 支持告警详情查看
- ✅ 新告警从下方生成
- ✅ 完善测试和文档

### 计划功能
- 🔄 支持自定义危险等级规则
- 🔄 告警声音提示
- 🔄 告警推送通知
- 🔄 告警统计分析

## 联系支持

如有问题或建议，请联系开发团队或提交Issue。 