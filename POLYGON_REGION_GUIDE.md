# 多边形警戒区域功能使用指南

## 功能概述

本系统新增了手动输入坐标点的方式来创建多边形警戒区域，与原有的鼠标框选功能并存，为用户提供更灵活的警戒区域配置方式。

## 功能特点

### 1. 双重配置方式
- **鼠标框选**：在视频上拖拽鼠标框选矩形区域（原有功能）
- **手动输入坐标**：手动输入坐标点创建任意形状的多边形区域（新增功能）

### 2. 支持的多边形类型
- **三角形**：最少3个点
- **矩形**：4个点
- **复杂多边形**：5个或更多点
- **任意形状**：只要点数量≥3即可

### 3. 精确的碰撞检测
- 使用OpenCV的`pointPolygonTest`函数进行精确的点在多边形内检测
- 支持检测框与多边形区域的重叠判断
- 支持边界框中心点、角点等多种检测方式

## 使用方法

### 方法一：鼠标框选（原有功能）

1. 在Web界面中点击"开始框选"按钮
2. 在视频画面上拖拽鼠标框选矩形区域
3. 松开鼠标后自动创建警戒区域

### 方法二：手动输入坐标点（新增功能）

1. 在Web界面的"手动输入坐标点"区域
2. 点击"添加点"按钮添加坐标点输入框
3. 为每个点输入X和Y坐标值
4. 至少添加3个点后，点击"创建多边形"按钮
5. 系统将根据输入的坐标点创建多边形警戒区域

#### 坐标点输入示例

**矩形区域（4个点）：**
```
点1: X=100, Y=100
点2: X=300, Y=100  
点3: X=300, Y=300
点4: X=100, Y=300
```

**三角形区域（3个点）：**
```
点1: X=200, Y=100
点2: X=300, Y=300
点3: X=100, Y=300
```

**复杂多边形（5个点）：**
```
点1: X=100, Y=100
点2: X=200, Y=50
点3: X=300, Y=100
点4: X=250, Y=200
点5: X=150, Y=200
```

## 技术实现

### 前端实现
- 动态添加坐标点输入框
- 实时验证坐标点数量（至少3个点）
- 支持删除单个坐标点
- 自动重新编号坐标点

### 后端实现
- 使用`cv2.pointPolygonTest`进行精确的点在多边形内检测
- 支持边界框与多边形区域的重叠判断
- 兼容原有的矩形区域检测逻辑

### 碰撞检测算法
```python
def _check_bbox_intersection(self, bbox, region_points):
    """检查边界框是否与危险区域有重合"""
    x1, y1, x2, y2 = bbox
    
    # 检查边界框的四个角点
    corners = [(x1, y1), (x2, y1), (x2, y2), (x1, y2)]
    for corner in corners:
        if cv2.pointPolygonTest(region_points, corner, False) >= 0:
            return True
    
    # 检查边界框的中心点
    center_x = (x1 + x2) // 2
    center_y = (y1 + y2) // 2
    if cv2.pointPolygonTest(region_points, (center_x, center_y), False) >= 0:
        return True
    
    # 检查边界框与区域的重叠
    bbox_rect = [x1, y1, x2, y2]
    region_rect = cv2.boundingRect(region_points)
    
    if (bbox_rect[0] < region_rect[0] + region_rect[2] and
        bbox_rect[0] + bbox_rect[2] > region_rect[0] and
        bbox_rect[1] < region_rect[1] + region_rect[3] and
        bbox_rect[1] + bbox_rect[3] > region_rect[1]):
        return True
    
    return False
```

## 测试验证

### 运行测试
```bash
# 运行多边形区域功能测试
python test_polygon_region.py

# 或使用批处理文件
run_polygon_test.bat
```

### 测试内容
1. **矩形区域测试**：验证4个点创建的矩形区域
2. **三角形区域测试**：验证3个点创建的三角形区域
3. **复杂多边形测试**：验证5个点创建的复杂多边形区域
4. **可视化测试**：生成测试图像验证检测结果
5. **停留时间检测**：验证停留时间跟踪功能

## 注意事项

### 坐标系统
- 坐标原点在视频画面的左上角
- X坐标向右递增，Y坐标向下递增
- 坐标值应为非负整数

### 多边形要求
- 至少需要3个点才能创建多边形
- 点应按顺时针或逆时针顺序输入
- 避免自相交的多边形（可能导致检测异常）

### 性能考虑
- 复杂多边形（点数量多）可能影响检测性能
- 建议使用合理数量的点来定义警戒区域
- 系统会自动优化检测算法

## 故障排除

### 常见问题

1. **"至少需要3个点才能创建多边形"错误**
   - 确保添加了至少3个坐标点
   - 检查所有坐标点都已输入有效数值

2. **坐标输入无效**
   - 确保输入的是数字
   - 检查坐标值是否在合理范围内

3. **检测不准确**
   - 检查坐标点是否按正确顺序输入
   - 避免创建自相交的多边形
   - 确保坐标值对应正确的视频分辨率

### 调试方法
- 查看生成的测试图像文件
- 检查控制台输出的调试信息
- 使用可视化工具验证多边形形状

## 更新日志

- **v1.0**：新增手动输入坐标点功能
- 支持任意形状的多边形警戒区域
- 优化碰撞检测算法
- 增强前端用户界面 